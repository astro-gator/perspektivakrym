# Документация по методу calculatePayments

## Система расчета графика платежей

### 1. Что нужно для расчета

#### 1.1 Входные данные из сделки Bitrix24

**Основные параметры:**
- `deal_id` - ID сделки в Bitrix24
- `auth` - токен авторизации приложения
- `number_graph` - номер графика (по умолчанию 0)

**Финансовые параметры:**
- `OPPORTUNITY` - общая сумма сделки
- `UF_CRM_1602665856` - первоначальный взнос (ПВ) по основному договору
- `UF_CRM_1610624104` - сумма по земле
- `UF_CRM_1610624123` - сумма по подряду
- `UF_CRM_1612333754254` - ПВ за подряд

**Даты:**
- `UF_CRM_1612354364` - дата окончания строительства
- `UF_CRM_1602665724` - дата создания договора
- `UF_CRM_1611646586442` - дата заключения подряда
- `UF_CRM_AMO_560317` - дата создания основного договора (ДДУ, земля, доп. лот)

**Временные параметры:**
- `UF_CRM_1610624156` - дней на внесение ПВ (ДДУ / земля / доп лот)
- `UF_CRM_1617787747` - дней на внесение ПВ (подряд)
- `UF_CRM_1602666205` - рассрочка, мес. (количество платежей)

**Частота платежей:**
- `UF_CRM_1615449388` - частота платежей:
  - 2302 - Месяц
  - 2304 - Квартал
  - 2306 - Полгода
  - 2308 - Год

**Номера договоров:**
- `UF_CRM_1611646713185` - номер основного договора (ДДУ, земля, доп. лот)
- `UF_CRM_1611646728314` - номер договора подряда

#### 1.2 Проверки перед расчетом

1. **Проверка авторизации** - проверяется токен приложения
2. **Проверка существования графика** - если график уже составлен, расчет не выполняется
3. **Проверка суммы сделки** - сумма должна быть больше 0
4. **Проверка обязательных дат** - дата окончания строительства и дата заключения основного договора должны быть указаны
5. **Проверка номеров договоров** - номера договоров должны быть указаны

### 2. Как происходит расчет

#### 2.1 Расчет количества платежей

```php
$count = floor(Carbon::create($finishDate)->diffInMonths(
    Carbon::create($dateStartMain)->addDays($daysFirstPayment)
) / $quantityFromFrequency);
```

**Логика:**
1. Вычисляется период от даты ПВ до даты окончания строительства
2. Период делится на частоту платежей для получения количества платежей
3. Используется `floor()` для округления вниз

#### 2.2 Расчет по основному договору

**Шаг 1: Первоначальный взнос (ПВ)**
```php
mainDownPaymentCalculate($dealId, $numberLand, $firstPayment, $dateStartMain, $daysFirstPayment, $numberGraph)
```

**Параметры:**
- Создается платеж типа `DOWN_PAYMENT`
- Дата = дата начала + дни на ПВ
- Статус: `BLOCK` (заблокирован)

**Шаг 2: Регулярные платежи**
```php
mainRegularPaymentCalculate($dealId, $numberLand, $landAmount, $firstPayment, $dateStartMain, $daysFirstPayment, $count, $paymentFrequency, $finishDate, $numberGraph)
```

**Алгоритм расчета суммы платежа:**
```php
$amount = ceil(($allAmount - $firstAmount) / $count);
```

**Логика распределения:**
1. Если платеж один - вся оставшаяся сумма
2. Если платежей несколько:
   - Первые (n-1) платежей: равные суммы
   - Последний платеж: остаток суммы

#### 2.3 Расчет по подряду (если есть)

**Шаг 1: ПВ по подряду**
```php
contractDownPaymentCalculate($dealId, $numberContract, $firstPaymentContract, $dateStart, $daysFirstContractPayment, $numberGraph)
```

**Особенности:**
- Дата ПВ подряда = дата ПВ земли
- Статус: `BLOCK` (заблокирован)

**Шаг 2: Регулярные платежи по подряду**
```php
contractRegularPaymentCalculate($dealId, $numberContract, $contractAmount, $firstPaymentContract, $dateStart, $daysFirstContractPayment, $count, $paymentFrequency, $numberGraph)
```

**Алгоритм аналогичен основному договору**

#### 2.4 Расчет дат платежей

**Метод `getPlanDate()`:**
```php
switch ($type) {
    case '2302': $carbDate = $carbDate->addMonth(); break;      // Месяц
    case '2304': $carbDate = $carbDate->addMonths(3); break;    // Квартал
    case '2306': $carbDate = $carbDate->addMonths(6); break;    // Полгода
    case '2308': $carbDate = $carbDate->addYear(); break;       // Год
}
```

### 3. Что мы имеем на выходе

#### 3.1 Структура данных платежа

Каждый платеж содержит:
- `deal_id` - ID сделки
- `type` - тип (MAIN/CONTRACT)
- `pay_type` - тип платежа (DOWN_PAYMENT/REGULAR_PAYMENT)
- `doc_number` - номер договора
- `amount` - сумма платежа
- `date` - дата платежа
- `blocked` - статус блокировки
- `note` - комментарий
- `order` - порядок
- `number_graph` - номер графика

#### 3.2 Типы платежей

**DOWN_PAYMENT (Первоначальный взнос):**
- Статус: `BLOCK` (заблокирован)
- Не подлежит изменению
- Создается автоматически

**REGULAR_PAYMENT (Регулярные платежи):**
- Статус: `ACTIVE` (активен)
- Может быть изменен
- Распределяется равномерно

#### 3.3 Результат расчета

1. **График платежей** - полный список плановых платежей
2. **Два типа договоров:**
   - Основной договор (ДДУ, земля, доп. лот)
   - Договор подряда (если есть)
3. **Структурированные данные** для отображения в интерфейсе
4. **Возможность дальнейшего редактирования** платежей

#### 3.4 Обработка ошибок

Система обрабатывает следующие ошибки:
- Неавторизованное приложение
- График уже составлен
- Сумма сделки равна 0
- Не указаны обязательные даты
- Не указаны номера договоров
- Неверная частота платежей

### 4. Особенности алгоритма

#### 4.1 Распределение сумм

**Принцип "последний платеж получает остаток":**
```php
$lastAmount = $allAmount - $firstAmount - ($amount * ($count - 1));
```

Это гарантирует точное соответствие общей сумме.

#### 4.2 Обработка резервов

При пересчете учитываются заблокированные платежи:
```php
$planPaymentMainAmountReserv = $this->mPlanPayment
    ->where('deal_id', $dealId)
    ->where('type', $this->mPlanPayment::MAIN)
    ->where('blocked', $this->mPlanPayment::BLOCK)
    ->sum('amount');
```

#### 4.3 Гибкость частоты платежей

Система поддерживает 4 варианта частоты:
- Ежемесячно (2302)
- Ежеквартально (2304)
- Раз в полгода (2306)
- Ежегодно (2308)

### 5. Пример расчета

**Входные данные:**
- Сумма сделки: 1,000,000 руб.
- ПВ: 200,000 руб.
- Сумма по земле: 800,000 руб.
- Сумма по подряду: 200,000 руб.
- ПВ по подряду: 50,000 руб.
- Частота: ежемесячно
- Период: 12 месяцев

**Результат:**
1. ПВ основной договор: 200,000 руб. (заблокирован)
2. Регулярные платежи основной договор: 11 платежей по 54,545 руб. + 1 платеж 54,545 руб.
3. ПВ подряд: 50,000 руб. (заблокирован)
4. Регулярные платежи подряд: 11 платежей по 13,636 руб. + 1 платеж 13,637 руб.

**Итого:** 24 платежа с точным соответствием общей сумме. 